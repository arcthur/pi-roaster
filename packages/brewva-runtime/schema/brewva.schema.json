{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$ref": "#/definitions/BrewvaConfigFile",
  "title": "brewva BrewvaConfigFile",
  "description": "JSON Schema for .brewva/brewva.json (Brewva config patch file).",
  "definitions": {
    "BrewvaConfigFile": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "$schema": {
          "type": "string"
        },
        "channels": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "orchestration": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "aclModeWhenOwnersEmpty": {
                  "type": "string",
                  "enum": ["open", "closed"]
                },
                "enabled": {
                  "type": "boolean"
                },
                "limits": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "a2aMaxDepth": {
                      "type": "number"
                    },
                    "a2aMaxHops": {
                      "type": "number"
                    },
                    "fanoutMaxAgents": {
                      "type": "number"
                    },
                    "idleRuntimeTtlMs": {
                      "type": "number"
                    },
                    "maxDiscussionRounds": {
                      "type": "number"
                    },
                    "maxLiveRuntimes": {
                      "type": "number"
                    }
                  }
                },
                "owners": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "telegram": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  }
                },
                "scopeStrategy": {
                  "type": "string",
                  "enum": ["chat", "thread"]
                }
              }
            }
          }
        },
        "infrastructure": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "contextBudget": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "adaptiveZones": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "downshiftIdleRatio": {
                      "type": "number"
                    },
                    "emaAlpha": {
                      "type": "number"
                    },
                    "enabled": {
                      "type": "boolean"
                    },
                    "maxShiftPerTurn": {
                      "type": "number"
                    },
                    "minTurnsBeforeAdapt": {
                      "type": "number"
                    },
                    "retirement": {
                      "type": "object",
                      "additionalProperties": false,
                      "properties": {
                        "checkIntervalHours": {
                          "type": "number"
                        },
                        "disableBelow": {
                          "type": "number"
                        },
                        "enabled": {
                          "type": "boolean"
                        },
                        "metricKey": {
                          "$ref": "#/definitions/ContextRetirementMetricKey"
                        },
                        "minSamples": {
                          "type": "number"
                        },
                        "reenableAbove": {
                          "type": "number"
                        }
                      }
                    },
                    "stepTokens": {
                      "type": "number"
                    },
                    "upshiftTruncationRatio": {
                      "type": "number"
                    }
                  }
                },
                "arena": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "degradationPolicy": {
                      "$ref": "#/definitions/ContextArenaDegradationPolicy"
                    },
                    "maxEntriesPerSession": {
                      "type": "number"
                    },
                    "zones": {
                      "type": "object",
                      "additionalProperties": false,
                      "properties": {
                        "identity": {
                          "type": "object",
                          "additionalProperties": false,
                          "properties": {
                            "max": {
                              "type": "number"
                            },
                            "min": {
                              "type": "number"
                            }
                          }
                        },
                        "memoryRecall": {
                          "type": "object",
                          "additionalProperties": false,
                          "properties": {
                            "max": {
                              "type": "number"
                            },
                            "min": {
                              "type": "number"
                            }
                          }
                        },
                        "memoryWorking": {
                          "type": "object",
                          "additionalProperties": false,
                          "properties": {
                            "max": {
                              "type": "number"
                            },
                            "min": {
                              "type": "number"
                            }
                          }
                        },
                        "ragExternal": {
                          "type": "object",
                          "additionalProperties": false,
                          "properties": {
                            "max": {
                              "type": "number"
                            },
                            "min": {
                              "type": "number"
                            }
                          }
                        },
                        "skills": {
                          "type": "object",
                          "additionalProperties": false,
                          "properties": {
                            "max": {
                              "type": "number"
                            },
                            "min": {
                              "type": "number"
                            }
                          }
                        },
                        "taskState": {
                          "type": "object",
                          "additionalProperties": false,
                          "properties": {
                            "max": {
                              "type": "number"
                            },
                            "min": {
                              "type": "number"
                            }
                          }
                        },
                        "toolFailures": {
                          "type": "object",
                          "additionalProperties": false,
                          "properties": {
                            "max": {
                              "type": "number"
                            },
                            "min": {
                              "type": "number"
                            }
                          }
                        },
                        "truth": {
                          "type": "object",
                          "additionalProperties": false,
                          "properties": {
                            "max": {
                              "type": "number"
                            },
                            "min": {
                              "type": "number"
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "compaction": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "minSecondsBetween": {
                      "type": "number"
                    },
                    "minTurnsBetween": {
                      "type": "number"
                    },
                    "pressureBypassPercent": {
                      "type": "number"
                    }
                  }
                },
                "compactionInstructions": {
                  "type": "string"
                },
                "compactionThresholdPercent": {
                  "type": "number"
                },
                "enabled": {
                  "type": "boolean"
                },
                "floorUnmetPolicy": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "enabled": {
                      "type": "boolean"
                    },
                    "finalFallback": {
                      "type": "string",
                      "const": "critical_only"
                    },
                    "relaxOrder": {
                      "type": "array",
                      "items": {
                        "type": "string",
                        "enum": [
                          "identity",
                          "truth",
                          "skills",
                          "task_state",
                          "tool_failures",
                          "memory_working",
                          "memory_recall",
                          "rag_external"
                        ]
                      }
                    },
                    "requestCompaction": {
                      "type": "boolean"
                    }
                  }
                },
                "hardLimitPercent": {
                  "type": "number"
                },
                "maxInjectionTokens": {
                  "type": "number"
                },
                "profile": {
                  "type": "string",
                  "enum": ["simple", "managed"]
                },
                "stabilityMonitor": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "consecutiveThreshold": {
                      "type": "number"
                    },
                    "enabled": {
                      "type": "boolean"
                    },
                    "retirement": {
                      "type": "object",
                      "additionalProperties": false,
                      "properties": {
                        "checkIntervalHours": {
                          "type": "number"
                        },
                        "disableBelow": {
                          "type": "number"
                        },
                        "enabled": {
                          "type": "boolean"
                        },
                        "metricKey": {
                          "$ref": "#/definitions/ContextRetirementMetricKey"
                        },
                        "minSamples": {
                          "type": "number"
                        },
                        "reenableAbove": {
                          "type": "number"
                        }
                      }
                    }
                  }
                },
                "truncationStrategy": {
                  "type": "string",
                  "enum": ["drop-entry", "summarize", "tail"]
                }
              }
            },
            "costTracking": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "actionOnExceed": {
                  "type": "string",
                  "enum": ["warn", "block_tools"]
                },
                "alertThresholdRatio": {
                  "type": "number"
                },
                "enabled": {
                  "type": "boolean"
                },
                "maxCostUsdPerSession": {
                  "type": "number"
                }
              }
            },
            "events": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "dir": {
                  "type": "string"
                },
                "enabled": {
                  "type": "boolean"
                },
                "level": {
                  "type": "string",
                  "enum": ["audit", "ops", "debug"]
                }
              }
            },
            "interruptRecovery": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "enabled": {
                  "type": "boolean"
                },
                "gracefulTimeoutMs": {
                  "type": "number"
                }
              }
            },
            "toolFailureInjection": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "enabled": {
                  "type": "boolean"
                },
                "maxEntries": {
                  "type": "number"
                },
                "maxOutputChars": {
                  "type": "number"
                }
              }
            },
            "turnWal": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "compactAfterMs": {
                  "type": "number"
                },
                "defaultTtlMs": {
                  "type": "number"
                },
                "dir": {
                  "type": "string"
                },
                "enabled": {
                  "type": "boolean"
                },
                "maxRetries": {
                  "type": "number"
                },
                "scheduleTurnTtlMs": {
                  "type": "number"
                }
              }
            }
          }
        },
        "ledger": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "checkpointEveryTurns": {
              "type": "number"
            },
            "path": {
              "type": "string"
            }
          }
        },
        "memory": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "cognitive": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "maxTokensPerTurn": {
                  "type": "number"
                },
                "mode": {
                  "type": "string",
                  "enum": ["off", "shadow", "active"]
                }
              }
            },
            "crystalMinUnits": {
              "type": "number"
            },
            "dailyRefreshHourLocal": {
              "type": "number"
            },
            "dir": {
              "type": "string"
            },
            "enabled": {
              "type": "boolean"
            },
            "evolvesMode": {
              "type": "string",
              "enum": ["off", "shadow"]
            },
            "externalRecall": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "builtinProvider": {
                  "type": "string",
                  "enum": ["off", "crystal-lexical"]
                },
                "enabled": {
                  "type": "boolean"
                },
                "injectedConfidence": {
                  "type": "number"
                },
                "minInternalScore": {
                  "type": "number"
                },
                "queryTopK": {
                  "type": "number"
                }
              }
            },
            "global": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "enabled": {
                  "type": "boolean"
                },
                "minConfidence": {
                  "type": "number"
                }
              }
            },
            "maxWorkingChars": {
              "type": "number"
            },
            "recallMode": {
              "type": "string",
              "enum": ["primary", "fallback"]
            },
            "retrievalTopK": {
              "type": "number"
            },
            "retrievalWeights": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "confidence": {
                  "type": "number"
                },
                "lexical": {
                  "type": "number"
                },
                "recency": {
                  "type": "number"
                }
              }
            },
            "workingFile": {
              "type": "string"
            }
          }
        },
        "parallel": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "maxConcurrent": {
              "type": "number"
            }
          }
        },
        "schedule": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "leaseDurationMs": {
              "type": "number"
            },
            "maxActiveIntentsGlobal": {
              "type": "number"
            },
            "maxActiveIntentsPerSession": {
              "type": "number"
            },
            "maxConsecutiveErrors": {
              "type": "number"
            },
            "maxRecoveryCatchUps": {
              "type": "number"
            },
            "minIntervalMs": {
              "type": "number"
            },
            "projectionPath": {
              "type": "string"
            }
          }
        },
        "security": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "execution": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "backend": {
                  "type": "string",
                  "enum": ["host", "sandbox", "auto"]
                },
                "commandDenyList": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "enforceIsolation": {
                  "type": "boolean"
                },
                "fallbackToHost": {
                  "type": "boolean"
                },
                "sandbox": {
                  "type": "object",
                  "additionalProperties": false,
                  "properties": {
                    "apiKey": {
                      "type": "string"
                    },
                    "cpus": {
                      "type": "number"
                    },
                    "defaultImage": {
                      "type": "string"
                    },
                    "memory": {
                      "type": "number"
                    },
                    "serverUrl": {
                      "type": "string"
                    },
                    "timeout": {
                      "type": "number"
                    }
                  }
                }
              }
            },
            "mode": {
              "type": "string",
              "enum": ["permissive", "standard", "strict"]
            },
            "sanitizeContext": {
              "type": "boolean"
            }
          }
        },
        "skills": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "disabled": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "overrides": {
              "type": "object",
              "additionalProperties": {
                "$ref": "#/definitions/SkillContractOverride"
              }
            },
            "packs": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "roots": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "selector": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "k": {
                  "type": "number"
                },
                "semanticFallback": {
                  "$ref": "#/definitions/SkillSelectorSemanticFallbackConfig"
                }
              }
            }
          }
        },
        "tape": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "checkpointIntervalEntries": {
              "type": "number"
            }
          }
        },
        "ui": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "quietStartup": {
              "type": "boolean"
            }
          }
        },
        "verification": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "checks": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "quick": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "standard": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "strict": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                }
              }
            },
            "commands": {
              "type": "object",
              "additionalProperties": {
                "type": "string"
              }
            },
            "defaultLevel": {
              "$ref": "#/definitions/VerificationLevel"
            }
          }
        }
      }
    },
    "ContextArenaDegradationPolicy": {
      "type": "string",
      "enum": ["drop_recall", "drop_low_priority", "force_compact"]
    },
    "ContextRetirementMetricKey": {
      "type": "string",
      "enum": ["floor_unmet_rate_7d", "zone_adaptation_benefit_7d"]
    },
    "SkillContractOverride": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "description": {
          "type": "string"
        },
        "antiTags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "budget": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "maxTokens": {
              "type": "number"
            },
            "maxToolCalls": {
              "type": "number"
            }
          }
        },
        "composableWith": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "consumes": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "costHint": {
          "$ref": "#/definitions/SkillCostHint"
        },
        "dispatch": {
          "$ref": "#/definitions/SkillDispatchPolicy"
        },
        "escalationPath": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "maxParallel": {
          "type": "number"
        },
        "name": {
          "type": "string"
        },
        "outputs": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "stability": {
          "type": "string",
          "enum": ["experimental", "stable", "deprecated"]
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "tier": {
          "$ref": "#/definitions/SkillTier"
        },
        "tools": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "required": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "denied": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "optional": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        },
        "triggers": {
          "$ref": "#/definitions/SkillTriggerPolicy"
        },
        "version": {
          "type": "string"
        }
      }
    },
    "SkillCostHint": {
      "type": "string",
      "enum": ["low", "medium", "high"]
    },
    "SkillDispatchMode": {
      "type": "string",
      "enum": ["suggest", "gate", "auto"]
    },
    "SkillDispatchPolicy": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "autoThreshold": {
          "type": "number"
        },
        "defaultMode": {
          "$ref": "#/definitions/SkillDispatchMode"
        },
        "gateThreshold": {
          "type": "number"
        }
      },
      "required": ["gateThreshold", "autoThreshold", "defaultMode"]
    },
    "SkillSelectorSemanticFallbackConfig": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "embeddingDimensions": {
          "type": "number"
        },
        "enabled": {
          "type": "boolean"
        },
        "lexicalBypassScore": {
          "type": "number"
        },
        "minSimilarity": {
          "type": "number"
        }
      },
      "required": ["enabled", "lexicalBypassScore", "minSimilarity", "embeddingDimensions"]
    },
    "SkillTier": {
      "type": "string",
      "enum": ["base", "pack", "project"]
    },
    "SkillTriggerNegativeRule": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "scope": {
          "$ref": "#/definitions/SkillTriggerNegativeScope"
        },
        "terms": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      },
      "required": ["scope", "terms"]
    },
    "SkillTriggerNegativeScope": {
      "type": "string",
      "enum": ["intent", "topic"]
    },
    "SkillTriggerPolicy": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "intents": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "negatives": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/SkillTriggerNegativeRule"
          }
        },
        "phrases": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "topics": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      },
      "required": ["intents", "topics", "phrases", "negatives"]
    },
    "VerificationLevel": {
      "type": "string",
      "enum": ["quick", "standard", "strict"]
    }
  }
}
